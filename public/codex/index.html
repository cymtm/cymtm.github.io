<!doctype html><html lang="en"><head>
<meta name="robots" content="noindex, nofollow">
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Codex — Our Rotting Fathers</title>
<link rel="stylesheet" href="/assets/style.css"/>
</head><body class="maelor">
  <div class="page">
    <div class="sheet">
      <div class="header"><span class="strap"><h1>The Codex of Our Rotting Fathers</h1></span></div>
      <div class="main">
        <div class="codex-meta" id="meta"></div>
        <div id="page"></div>
        <div class="codex-nav">
          <button id="prev">◀︎ Prev</button>
          <span id="pos"></span>
          <button id="next">Next ▶︎</button>
        </div>
      </div>
      <div class="bar" aria-hidden="true" style="justify-content:center;color:#e6d7c3;">Turn softly. The ink is still wet.</div>
    </div>
  </div>
<script>
const FILES = []; // will be filled from index.json

const state = { entries:[], ei:0, pi:0 };
const metaEl = document.getElementById('meta');
const pageEl = document.getElementById('page');
const posEl  = document.getElementById('pos');
const prevBtn= document.getElementById('prev');
const nextBtn= document.getElementById('next');

async function loadManifest(){
  const r = await fetch('/lore/index.json', {cache:'no-store'});
  if(!r.ok) throw new Error('manifest fetch failed');
  return r.json();
}
async function loadTxt(path){
  const r = await fetch(path, {cache:'no-store'}); if(!r.ok) throw new Error('lore fetch failed');
  return r.text();
}
async function loadEntry(base, item){
  const raw = await loadTxt(base + item.file);
  const paras = raw.trim().split(/\n\s*\n/).map(p=>p.trim());
  return { meta:item, paras };
}
async function boot(){
  const man = await loadManifest(); // {version, base, entries:[{file,title,era,tags}]}
  const sorted = man.entries.slice().sort((a,b)=>a.file.localeCompare(b.file));
  for (const e of sorted){ state.entries.push(await loadEntry(man.base, e)); }
  render();
}
function render(){
  const e = state.entries[state.ei], p = e.paras[state.pi];
  metaEl.textContent = `${e.meta.title} — ${e.meta.era||''} ${e.meta.tags && e.meta.tags.length ? '— '+e.meta.tags.join(' ') : ''}`;
  pageEl.innerHTML = p.split(/\n+/).map(s=>`<p>${s}</p>`).join('');
  posEl.textContent = `Entry ${state.ei+1}/${state.entries.length} • Page ${state.pi+1}/${e.paras.length}`;
  prevBtn.disabled = state.ei===0 && state.pi===0;
  nextBtn.disabled = state.ei===state.entries.length-1 && state.pi===e.paras.length-1;
  pageEl.animate([{opacity:.0,filter:'blur(2px)'},{opacity:1,filter:'blur(0)'}],{duration:220,easing:'ease-out'});
}
function next(){
  const e = state.entries[state.ei];
  if (state.pi < e.paras.length-1) state.pi++;
  else if (state.ei < state.entries.length-1){ state.ei++; state.pi=0; }
  render();
}
function prev(){
  if (state.pi > 0) state.pi--;
  else if (state.ei > 0){ state.ei--; state.pi = state.entries[state.ei].paras.length-1; }
  render();
}
nextBtn.addEventListener('click', next);
prevBtn.addEventListener('click', prev);
document.addEventListener('keydown', e=>{
  if(e.key==='ArrowRight'||e.key==='PageDown') next();
  if(e.key==='ArrowLeft' ||e.key==='PageUp')   prev();
});
boot();
</script>
</body></html>
